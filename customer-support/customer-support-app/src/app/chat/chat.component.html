<div class="chat-container">
  <div class="chat-messages" #chatMessages>
    <div class="messages-content">
      <ng-container *ngFor="let message of messages">
        <div *ngIf="message.text.trim().length > 0"
             [ngClass]="{'user-message': message.sender === 'user', 'server-message': message.sender === 'server'}">
          <div>
            <markdown [data]="message.text"></markdown>
          </div>
        </div>
      </ng-container>

      <!-- Typing indicator as a message at the bottom -->
      <div class="typing-message" [class.active]="isConnected">
        <div class="typing-indicator">
          <span>AI is thinking</span>
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
        <button type="button" class="stop-button" (click)="closeWebSocket()" title="Stop generating">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <rect x="6" y="6" width="12" height="12" rx="2"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
  <div class="chat-input">
    <form (ngSubmit)="sendMessage()">
      <app-error/>

      <div class="input-group">
        <textarea [(ngModel)]="messageToSend"
                  class="form-control"
                  aria-label="Type your message"
                  name="messageToSend"
                  placeholder="Type your message..."
                  (keydown.enter)="submitForm($event)"></textarea>
        <button type="submit" class="btn btn-primary send-btn" [disabled]="buttonDisabled">
          <span *ngIf="!isConnected">Send</span>
          <span *ngIf="isConnected">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="loading-icon">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
                <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
              </circle>
            </svg>
          </span>
        </button>
      </div>
    </form>
  </div>
</div>
